<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Pitch Booking System</title>
    
    <script src="firebase-config.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height:100vh;
            padding:20px;
        }
        .container {
            max-width:1400px;
            margin:0 auto;
            background:white;
            border-radius:20px;
            box-shadow:0 20px 60px rgba(0,0,0,0.1);
            overflow:hidden;
        }
        .header {
            background:linear-gradient(135deg, #2c3e50, #34495e);
            color:white; padding:30px; text-align:center; position:relative;
        }
        .header h1 { font-size:2.5em; margin-bottom:10px; }
        .header-btn {
            background:rgba(255,255,255,0.2);
            border:2px solid rgba(255,255,255,0.3);
            color:white; padding:10px 20px; border-radius:25px;
            cursor:pointer; font-size:14px; font-weight:600;
        }
        .export-btn { position:absolute; top:20px; right:20px; }
        .import-btn { position:absolute; top:20px; right:150px; }
        .signout-btn {
            position:absolute; top:20px; left:20px; background:#dc3545;
        }
        .tabs { display:flex; background:#f8f9fa; border-bottom:3px solid #e9ecef; }
        .tab { flex:1; padding:20px; text-align:center; background:#e9ecef; cursor:pointer; font-weight:bold; }
        .tab.active { background:white; color:#2c3e50; }
        .content { padding:30px; }
        .booking-form, .filter-bar { background:#f8f9fa; padding:20px; border-radius:15px; margin-bottom:30px; }
        .form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:20px; }
        .form-group { display:flex; flex-direction:column; }
        .form-group label { font-weight:600; margin-bottom:8px; }
        .form-group input, .form-group select { padding:12px; border:2px solid #e9ecef; border-radius:10px; }
        #yearFilter, #repeatClientMonthFilter, #repeatClientYearFilter, #pitchRevenueMonthFilter, #pitchRevenueYearFilter { padding: 5px 10px; border-radius: 8px; border: 1px solid #ddd; background-color: white; }
        .calculated-field { background:#f8f9fa !important; font-weight:600; }
        .btn { padding:12px 20px; background:linear-gradient(135deg, #667eea, #764ba2); color:white; border:none; border-radius:25px; cursor:pointer; font-weight:600; }
        .btn:hover { opacity:0.9; }
        .booking-table { margin-top:20px; border-radius:15px; overflow:hidden; }
        .booking-table table { width:100%; border-collapse:collapse; }
        .booking-table th { background:#34495e; color:white; padding:15px; }
        .booking-table td { padding:12px; border-bottom:1px solid #eee; }
        .delete-btn { background:#dc3545; color:white; border:none; padding:8px 12px; border-radius:20px; cursor:pointer; }
        .dashboard-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; }
        .dashboard-card { background:#f9f9f9; padding:20px; border-radius:15px; }
        .card-title { font-weight:bold; margin-bottom:10px; }
        .metric { background:#667eea; color:white; border-radius:10px; padding:15px; text-align:center; }
        .metric-value { font-size:2em; font-weight:bold; }
        .empty-state { text-align:center; color:#666; padding:20px; }
        #calendarGrid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
        #calendarGrid div { background:#fff; border:1px solid #ddd; border-radius:10px; padding:5px; min-height:80px; }
        .filter-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: end; }
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none; align-items: center; justify-content: center;
            z-index: 2000; padding: 20px;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-box h2 { margin-bottom: 10px; color: #2c3e50; }
        .login-box .form-group { text-align: left; margin-bottom: 20px; }
        .login-options { display: flex; align-items: center; justify-content: center; margin-bottom: 25px; gap: 8px; color: #555; }
        #login-error { color: #dc3545; margin-top: 15px; font-weight: 600; display: none; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2>âš½ Login</h2>
            <p style="color:#777; margin-bottom:25px;">EP Sports Booking System</p>
            <div class="form-group">
                <label for="username">Username</label>
                <input id="username" type="text">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input id="password" type="password">
            </div>
            <div class="login-options">
                <input type="checkbox" id="keepLoggedIn" style="width:auto;">
                <label for="keepLoggedIn">Keep me logged in</label>
            </div>
            <button id="loginButton" class="btn">Login</button>
            <p id="login-error">Invalid username or password.</p>
        </div>
    </div>

    <div id="app-wrapper" style="display:none;">
        <div class="container">
            <div class="header">
                <button id="signOutButton" class="header-btn signout-btn">Sign Out</button>
                <h1>âš½ Football Pitch Booking System</h1>
                <p>Manage your pitch rentals and track revenue</p>
                <input type="file" id="importFile" style="display:none;" accept=".xlsx, .xls">
                <button id="importButton" class="header-btn import-btn">ðŸ“¥ Import</button>
                <button id="exportButton" class="header-btn export-btn">ðŸ“Š Export</button>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="bookings">ðŸ“‹ Bookings</div>
                <div class="tab" data-tab="dashboard">ðŸ“Š Dashboard</div>
                <div class="tab" data-tab="calendar">ðŸ“… Calendar</div>
            </div>

            <div class="content"></div>
        </div>

        <div id="bookingDetailsPanel" style="display:none;"></div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    
    // --- START: FIREBASE SETUP ---
    let firestore;
    if (typeof firebaseConfig !== 'undefined' && firebaseConfig.apiKey && !firebaseConfig.apiKey.startsWith("PASTE_YOUR")) {
        firebase.initializeApp(firebaseConfig);
        firestore = firebase.firestore();
    } else {
        console.error("Firebase config object not found or is invalid. Make sure `firebase-config.js` is loaded correctly and contains your keys.");
        document.body.innerHTML = '<h1>Firebase configuration is missing or invalid. Please set up `firebase-config.js`.</h1>';
        return; // Stop script execution if Firebase is not configured
    }
    // --- END: FIREBASE SETUP ---

    // --- GLOBAL VARIABLES & CONSTANTS ---
    let inactivityTimer;
    let monthlyRevenueChart;
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    // --- AUTHENTICATION & SESSION MANAGEMENT ---
    function handleLogin() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        const keepLoggedIn = document.getElementById('keepLoggedIn').checked;
        const errorEl = document.getElementById('login-error');
        if (user === "EPsports2025" && pass === "EPsport@25") {
            const storage = keepLoggedIn ? localStorage : sessionStorage;
            storage.setItem('isLoggedIn', 'true');
            errorEl.style.display = 'none';
            showApp();
        } else {
            errorEl.style.display = 'block';
        }
    }

    function signOut() {
        sessionStorage.removeItem('isLoggedIn');
        localStorage.removeItem('isLoggedIn');
        location.reload();
    }

    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(signOut, 3 * 60 * 60 * 1000);
    }

    async function showApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-wrapper').style.display = 'block';
        await setupBookingFilters();
        await displayBookings(); 
        await calendar.renderCalendar(); 
        await updateDashboard();
        resetInactivityTimer();
        ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => 
            window.addEventListener(event, resetInactivityTimer)
        );
    }

    // --- DATABASE CLASS ---
    class FirebaseDB { /* ... unchanged from previous correct version ... */ }
    const db = new FirebaseDB();

    // --- CORE BOOKING LOGIC ---
    function toggleRecurringOptions() { /* ... unchanged ... */ }
    async function isConflict(bookingData) { /* ... unchanged ... */ }
    async function addBooking() { /* ... unchanged ... */ }
    async function deleteBooking(id){ if(confirm("Are you sure you want to delete this booking?")){ await db.deleteBooking(id); await displayBookings(); await calendar.renderCalendar(); await updateDashboard(); } }

    // --- UI DISPLAY & UPDATE FUNCTIONS ---
    async function updateDashboard() { /* ... unchanged ... */ }
    async function setupBookingFilters() { /* ... unchanged ... */ }
    function clearBookingFilters() { /* ... unchanged ... */ }
    async function displayBookings(){ /* ... unchanged ... */ }
    
    function switchTab(tabName){
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        
        const activeTab = document.querySelector(`.tab[data-tab='${tabName}']`);
        if (activeTab) activeTab.classList.add('active');
        
        const activeContent = document.getElementById(tabName + '-content');
        if (activeContent) activeContent.style.display = 'block';
        
        if(tabName === 'calendar') calendar.renderCalendar();
        if(tabName === 'dashboard') updateDashboard();
    }

    // --- FILE I/O ---
    async function exportToExcel() { /* ... unchanged ... */ }
    async function handleFileUpload(event) { /* ... unchanged ... */ }

    // --- CALENDAR ---
    class CalendarController{ /* ... unchanged ... */ }
    const calendar = new CalendarController();
    function closeBookingDetails(){document.getElementById("bookingDetailsPanel").style.display="none";}
    async function deleteBookingFromCalendar(id){ await deleteBooking(id); closeBookingDetails(); }

    // --- INITIAL APP STARTUP & EVENT LISTENERS ---
    if (localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true') {
        showApp();
    } else {
        document.getElementById('login-screen').style.display = 'flex';
    }
    
    // Attach all event listeners using JavaScript
    document.getElementById('loginButton').addEventListener('click', handleLogin);
    document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
    document.getElementById('signOutButton').addEventListener('click', signOut);
    document.getElementById('importButton').addEventListener('click', () => document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', handleFileUpload);
    document.getElementById('exportButton').addEventListener('click', exportToExcel);

    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    // Dashboard Filter Listeners
    document.getElementById('yearFilter').addEventListener('change', updateDashboard);
    document.getElementById('repeatClientMonthFilter').addEventListener('change', updateDashboard);
    document.getElementById('repeatClientYearFilter').addEventListener('change', updateDashboard);
    document.getElementById('pitchRevenueMonthFilter').addEventListener('change', updateDashboard);
    document.getElementById('pitchRevenueYearFilter').addEventListener('change', updateDashboard);
    
    // Bookings Tab Filter Listeners
    document.getElementById('filterClientName').addEventListener('input', displayBookings);
    document.getElementById('filterPitch').addEventListener('change', displayBookings);
    document.getElementById('filterMonth').addEventListener('change', displayBookings);
    document.getElementById('filterYear').addEventListener('change', displayBookings);
    document.getElementById('addBookingButton').addEventListener('click', addBooking);
    document.getElementById('clearFiltersButton').addEventListener('click', clearBookingFilters);

    // Calendar Listeners
    document.getElementById('prevMonthBtn').addEventListener('click', () => calendar.navigateMonth(-1));
    document.getElementById('nextMonthBtn').addEventListener('click', () => calendar.navigateMonth(1));
    document.getElementById('todayBtn').addEventListener('click', () => calendar.goToToday());
    
    // Event Delegation for dynamic delete buttons
    document.getElementById('bookingsTableBody').addEventListener('click', e => {
        if (e.target && e.target.classList.contains('delete-btn')) {
            deleteBooking(e.target.dataset.id);
        }
    });

    document.getElementById('bookingDetailsContent').addEventListener('click', e => {
        if (e.target && e.target.id === 'detailsDeleteBtn') {
            deleteBookingFromCalendar(e.target.dataset.id);
        }
    });

    document.getElementById('detailsCloseBtn').addEventListener('click', closeBookingDetails);
});
</script>
</body>
</html>
