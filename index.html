<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Pitch Booking System</title>
    
    <script src="firebase-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI', sans-serif; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height:100vh; padding:20px; }
        .container { max-width:1400px; margin:0 auto; background:white; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.1); overflow:hidden; }
        .header { background:linear-gradient(135deg, #2c3e50, #34495e); color:white; padding:30px; text-align:center; position:relative; }
        .header h1 { font-size:2.5em; margin-bottom:10px; }
        .header-btn { background:rgba(255,255,255,0.2); border:2px solid rgba(255,255,255,0.3); color:white; padding:10px 20px; border-radius:25px; cursor:pointer; font-size:14px; font-weight:600; }
        .signout-btn { position:absolute; top:20px; left:20px; background:#dc3545; }
        .content { padding:30px; }
        .booking-form { background:#f8f9fa; padding:20px; border-radius:15px; margin-bottom:30px; }
        .form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:20px; }
        .form-group { display:flex; flex-direction:column; }
        .form-group label { font-weight:600; margin-bottom:8px; }
        .form-group input, .form-group select { padding:12px; border:2px solid #e9ecef; border-radius:10px; }
        .btn { padding:12px 20px; background:linear-gradient(135deg, #667eea, #764ba2); color:white; border:none; border-radius:25px; cursor:pointer; font-weight:600; }
        .booking-table table { width:100%; border-collapse:collapse; }
        .booking-table th { background:#34495e; color:white; padding:15px; }
        .booking-table td { padding:12px; border-bottom:1px solid #eee; }
        .delete-btn { background:#dc3545; color:white; border:none; padding:8px 12px; border-radius:20px; cursor:pointer; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center; }
        .login-box h2 { margin-bottom: 10px; color: #2c3e50; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2>⚽ Login</h2>
            <div class="form-group" style="text-align: left; margin-top: 25px;">
                <label for="username">Username</label>
                <input id="username" type="text">
            </div>
            <div class="form-group" style="text-align: left; margin-bottom: 20px;">
                <label for="password">Password</label>
                <input id="password" type="password">
            </div>
            <button id="loginButton" class="btn">Login</button>
            <p id="login-error" style="color: #dc3545; margin-top: 15px; font-weight: 600; display: none;">Invalid username or password.</p>
        </div>
    </div>

    <div id="app-wrapper" style="display:none;">
        <div class="container">
            <div class="header">
                <button id="signOutButton" class="header-btn signout-btn">Sign Out</button>
                <h1>⚽ Football Pitch Booking System</h1>
                <p>Core Booking Functionality</p>
            </div>
            <div class="content">
                <form id="bookingForm" class="booking-form">
                    <h2>Add New Booking</h2>
                    <div class="form-row">
                        <div class="form-group"><label>Pitch *</label>
                            <select id="pitch">
                                <option value="">Select</option>
                                <option>Fifa Pitch</option>
                                <option>Junior Football Pitch</option>
                                <option>Airdome</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Client *</label><input id="clientName"></div>
                        <div class="form-group"><label>Contact *</label><input id="contact"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Date *</label><input type="date" id="bookingDate"></div>
                        <div class="form-group"><label>Start *</label><input type="time" id="startTime"></div>
                        <div class="form-group"><label>End *</label><input type="time" id="endTime"></div>
                    </div>
                     <div class="form-row">
                        <div class="form-group"><label>Price/hr *</label><input type="number" id="pricePerHour"></div>
                    </div>
                    <button id="addBookingButton" class="btn" type="button">Add Booking</button>
                </form>

                <div class="booking-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Pitch</th><th>Client</th><th>Date</th><th>Start</th><th>End</th><th>Contact</th><th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    
    let firestore;
    try {
        if (typeof firebase !== 'undefined' && typeof firebaseConfig !== 'undefined' && firebaseConfig.apiKey && !firebaseConfig.apiKey.startsWith("PASTE_YOUR")) {
            firebase.initializeApp(firebaseConfig);
            firestore = firebase.firestore();
        } else {
            throw new Error("Firebase config object not found or is invalid.");
        }
    } catch (error) {
        console.error("Firebase initialization failed:", error);
        document.body.innerHTML = `<h1>Error: Could not initialize Firebase. Please ensure firebase-config.js is correct and Firebase SDKs are loaded.</h1>`;
        return;
    }

    // --- AUTHENTICATION ---
    function handleLogin() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        if (user === "EPsports2025" && pass === "EPsport@25") {
            sessionStorage.setItem('isLoggedIn', 'true');
            showApp();
        } else {
            document.getElementById('login-error').style.display = 'block';
        }
    }

    function signOut() {
        sessionStorage.removeItem('isLoggedIn');
        location.reload();
    }

    async function showApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-wrapper').style.display = 'block';
        await displayBookings(); 
    }

    // --- DATABASE CLASS ---
    class FirebaseDB {
        constructor() { this.bookingsCollection = firestore.collection("bookings"); }
        async getAllBookings() {
            const snapshot = await this.bookingsCollection.orderBy("date").get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        async addBooking(data) {
            const docRef = await this.bookingsCollection.add(data);
            return { id: docRef.id, ...data };
        }
        async deleteBooking(id) { await this.bookingsCollection.doc(id).delete(); }
    }
    const db = new FirebaseDB();

    // --- CORE LOGIC ---
    async function isConflict(bookingData) {
        try {
            const newStart = new Date(`1970-01-01T${bookingData.startTime}`);
            const newEnd = new Date(`1970-01-01T${bookingData.endTime}`);
            const querySnapshot = await firestore.collection("bookings")
                .where("pitch", "==", bookingData.pitch)
                .where("date", "==", bookingData.date)
                .get();
            if (querySnapshot.empty) return false;
            for (const doc of querySnapshot.docs) {
                const existing = doc.data();
                const existingStart = new Date(`1970-01-01T${existing.startTime}`);
                const existingEnd = new Date(`1970-01-01T${existing.endTime}`);
                if (newStart < existingEnd && newEnd > existingStart) return true;
            }
            return false;
        } catch (error) {
            console.error("Error checking for conflicts:", error);
            alert("Could not check for booking conflicts due to a database error. This can happen if the required index in Firestore is not set up. Please check the console for details.");
            return true;
        }
    }

    async function addBooking(){
        try {
            const data = {
                pitch: document.getElementById("pitch").value,
                clientName: document.getElementById("clientName").value,
                contact: document.getElementById("contact").value,
                date: document.getElementById("bookingDate").value,
                startTime: document.getElementById("startTime").value,
                endTime: document.getElementById("endTime").value,
                pricePerHour: parseFloat(document.getElementById("pricePerHour").value)
            };
            if(!data.pitch || !data.clientName || !data.date || !data.startTime || !data.endTime || isNaN(data.pricePerHour)){
                alert("Please fill all required fields."); return;
            }
            if (new Date(`1970-01-01T${data.startTime}`) >= new Date(`1970-01-01T${data.endTime}`)) {
                alert("Error: Start time must be before the end time."); return;
            }
            if (await isConflict(data)) {
                alert(`Booking Conflict: The selected time on ${data.pitch} for ${data.date} is unavailable.`); return;
            }
            
            await db.addBooking(data);
            alert("Booking added successfully!");
            location.reload();

        } catch (error) {
            console.error("Failed to add booking:", error);
            alert("An error occurred while adding the booking. Please check the console for details.");
        }
    }

    async function deleteBooking(id){ 
        if(confirm("Are you sure you want to delete this booking?")){ 
            await db.deleteBooking(id); 
            await displayBookings();
        } 
    }

    async function displayBookings(){
        const bookings = await db.getAllBookings();
        const tbody = document.getElementById("bookingsTableBody");
        if(!bookings.length){
            tbody.innerHTML="<tr><td colspan='7'>No bookings found.</td></tr>";
            return;
        }
        tbody.innerHTML = bookings.map(b => `
            <tr>
                <td>${b.pitch}</td>
                <td>${b.clientName}</td>
                <td>${b.date}</td>
                <td>${b.startTime}</td>
                <td>${b.endTime}</td>
                <td>${b.contact}</td>
                <td><button class="delete-btn" data-id="${b.id}">Delete</button></td>
            </tr>`).join("");
    }
    
    // --- INITIAL STARTUP & EVENT LISTENERS ---
    if (sessionStorage.getItem('isLoggedIn') === 'true') {
        showApp();
    } else {
        document.getElementById('login-screen').style.display = 'flex';
    }
    
    document.getElementById('loginButton').addEventListener('click', handleLogin);
    document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
    document.getElementById('signOutButton').addEventListener('click', signOut);
    document.getElementById('addBookingButton').addEventListener('click', addBooking);
    
    document.getElementById('bookingsTableBody').addEventListener('click', e => {
        if (e.target && e.target.classList.contains('delete-btn')) {
            deleteBooking(e.target.dataset.id);
        }
    });
});
</script>
</body>
</html>
