<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Pitch Booking System</title>
    
    <script src="firebase-config.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height:100vh;
            padding:20px;
        }
        /* All other CSS styles remain the same */
        .container { max-width:1400px; margin:0 auto; background:white; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.1); overflow:hidden; }
        .header { background:linear-gradient(135deg, #2c3e50, #34495e); color:white; padding:30px; text-align:center; position:relative; }
        .header h1 { font-size:2.5em; margin-bottom:10px; }
        .header-btn { background:rgba(255,255,255,0.2); border:2px solid rgba(255,255,255,0.3); color:white; padding:10px 20px; border-radius:25px; cursor:pointer; font-size:14px; font-weight:600; }
        .export-btn { position:absolute; top:20px; right:20px; }
        .import-btn { position:absolute; top:20px; right:150px; }
        .signout-btn { position:absolute; top:20px; left:20px; background:#dc3545; }
        .tabs { display:flex; background:#f8f9fa; border-bottom:3px solid #e9ecef; }
        .tab { flex:1; padding:20px; text-align:center; background:#e9ecef; cursor:pointer; font-weight:bold; }
        .tab.active { background:white; color:#2c3e50; }
        .content { padding:30px; }
        .booking-form, .filter-bar { background:#f8f9fa; padding:20px; border-radius:15px; margin-bottom:30px; }
        .form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:20px; }
        .form-group { display:flex; flex-direction:column; }
        .form-group label { font-weight:600; margin-bottom:8px; }
        .form-group input, .form-group select { padding:12px; border:2px solid #e9ecef; border-radius:10px; }
        #yearFilter, #repeatClientMonthFilter, #repeatClientYearFilter, #pitchRevenueMonthFilter, #pitchRevenueYearFilter { padding: 5px 10px; border-radius: 8px; border: 1px solid #ddd; background-color: white; }
        .calculated-field { background:#f8f9fa !important; font-weight:600; }
        .btn { padding:12px 20px; background:linear-gradient(135deg, #667eea, #764ba2); color:white; border:none; border-radius:25px; cursor:pointer; font-weight:600; }
        .btn:hover { opacity:0.9; }
        .booking-table { margin-top:20px; border-radius:15px; overflow:hidden; }
        .booking-table table { width:100%; border-collapse:collapse; }
        .booking-table th { background:#34495e; color:white; padding:15px; }
        .booking-table td { padding:12px; border-bottom:1px solid #eee; }
        .delete-btn { background:#dc3545; color:white; border:none; padding:8px 12px; border-radius:20px; cursor:pointer; }
        .dashboard-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; }
        .dashboard-card { background:#f9f9f9; padding:20px; border-radius:15px; }
        .card-title { font-weight:bold; margin-bottom:10px; }
        .metric { background:#667eea; color:white; border-radius:10px; padding:15px; text-align:center; }
        .metric-value { font-size:2em; font-weight:bold; }
        .empty-state { text-align:center; color:#666; padding:20px; }
        #calendarGrid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
        #calendarGrid div { background:#fff; border:1px solid #ddd; border-radius:10px; padding:5px; min-height:80px; }
        .filter-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: end; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center; }
        .login-box h2 { margin-bottom: 10px; color: #2c3e50; }
        .login-box .form-group { text-align: left; margin-bottom: 20px; }
        .login-options { display: flex; align-items: center; justify-content: center; margin-bottom: 25px; gap: 8px; color: #555; }
        #login-error { color: #dc3545; margin-top: 15px; font-weight: 600; display: none; }
    </style>
</head>
<body>
    <div id="login-screen"></div>
    <div id="app-wrapper" style="display:none;"></div>

<script>
// WRAP ENTIRE SCRIPT IN DOMCONTENTLOADED TO PREVENT RACE CONDITIONS
document.addEventListener("DOMContentLoaded", () => {
    
    let firestore;
    if (typeof firebaseConfig !== 'undefined' && firebaseConfig.apiKey && !firebaseConfig.apiKey.startsWith("PASTE_YOUR")) {
        try {
            firebase.initializeApp(firebaseConfig);
            firestore = firebase.firestore();
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.body.innerHTML = `<h1>Error initializing Firebase. Check console for details.</h1>`;
            return;
        }
    } else {
        console.error("Firebase config object not found or is invalid.");
        document.body.innerHTML = '<h1>Firebase configuration is missing or invalid. Please set up `firebase-config.js`.</h1>';
        return;
    }

    let inactivityTimer;
    let monthlyRevenueChart;
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    function handleLogin() { /* ... unchanged ... */ }
    function signOut() { /* ... unchanged ... */ }
    function resetInactivityTimer() { /* ... unchanged ... */ }
    async function showApp() { /* ... unchanged ... */ }

    class FirebaseDB {
        constructor() { this.bookingsCollection = firestore.collection("bookings"); }
        async getAllBookings() {
            const snapshot = await this.bookingsCollection.orderBy("date").get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        async addBooking(data) {
            const hours = (new Date(`1970-01-01T${data.endTime}`) - new Date(`1970-01-01T${data.startTime}`)) / (1000 * 60 * 60);
            const newBooking = { ...data, hours, totalPayment: hours * data.pricePerHour };
            const docRef = await this.bookingsCollection.add(newBooking);
            return { id: docRef.id, ...newBooking };
        }
        async deleteBooking(id) { await this.bookingsCollection.doc(id).delete(); }
    }
    const db = new FirebaseDB();

    function toggleRecurringOptions() { /* ... unchanged ... */ }
    
    async function isConflict(bookingData) {
        try {
            const newStart = new Date(`1970-01-01T${bookingData.startTime}`);
            const newEnd = new Date(`1970-01-01T${bookingData.endTime}`);
            const querySnapshot = await firestore.collection("bookings")
                .where("pitch", "==", bookingData.pitch)
                .where("date", "==", bookingData.date)
                .get();
            if (querySnapshot.empty) return false;
            for (const doc of querySnapshot.docs) {
                const existingBooking = doc.data();
                const existingStart = new Date(`1970-01-01T${existingBooking.startTime}`);
                const existingEnd = new Date(`1970-01-01T${existingBooking.endTime}`);
                if (newStart < existingEnd && newEnd > existingStart) return true;
            }
            return false;
        } catch (error) {
            console.error("Error checking for conflicts:", error);
            alert("Could not check for booking conflicts. This might be due to missing database indexes. Please check the Firebase console.");
            return true; // Assume conflict on error to prevent double booking
        }
    }

    async function addBooking(){
        try {
            const data = {
                pitch: document.getElementById("pitch").value, clientName: document.getElementById("clientName").value,
                contact: document.getElementById("contact").value, date: document.getElementById("bookingDate").value,
                startTime: document.getElementById("startTime").value, endTime: document.getElementById("endTime").value,
                pricePerHour: parseFloat(document.getElementById("pricePerHour").value)
            };
            if(!data.pitch || !data.clientName || !data.contact || !data.date || !data.startTime || !data.endTime || isNaN(data.pricePerHour)){
                alert("Please fill all required fields with valid data."); return;
            }
            if (new Date(`1970-01-01T${data.startTime}`) >= new Date(`1970-01-01T${data.endTime}`)) {
                alert("Error: Start time must be before the end time."); return;
            }
            const recurringType = document.getElementById('recurringType').value;
            const recurringCount = parseInt(document.getElementById('recurringCount').value, 10);
            if (recurringType === 'none') {
                if (await isConflict(data)) {
                    alert(`Booking Conflict: The selected time on ${data.pitch} for ${data.date} is unavailable.`); return;
                }
                await db.addBooking(data);
                alert("Booking added successfully!");
            } else {
                if (!recurringCount || recurringCount < 1) {
                    alert('Please enter a valid number of repetitions.'); return;
                }
                if (recurringCount > 10 && !confirm(`This will create ${recurringCount} bookings. Are you sure?`)) return;
                
                const potentialBookings = [];
                const conflicts = [];
                const [year, month, day] = data.date.split('-').map(Number);
                const initialUTCDate = new Date(Date.UTC(year, month - 1, day));

                for (let i = 0; i < recurringCount; i++) {
                    const newBookingData = { ...data };
                    const nextDate = new Date(initialUTCDate);
                    if (recurringType === 'weekly') nextDate.setUTCDate(initialUTCDate.getUTCDate() + (i * 7));
                    else if (recurringType === 'monthly') nextDate.setUTCMonth(initialUTCDate.getUTCMonth() + i);
                    newBookingData.date = nextDate.toISOString().slice(0, 10);
                    if (await isConflict(newBookingData)) conflicts.push(newBookingData.date);
                    potentialBookings.push(newBookingData);
                }

                if (conflicts.length > 0) {
                    alert(`Booking Conflict Found:\nUnavailable dates for ${data.pitch}:\n\n${conflicts.join('\n')}\n\nNo bookings were added.`);
                    return;
                } else {
                    for(const booking of potentialBookings) { await db.addBooking(booking); }
                    alert(`${recurringCount} recurring bookings added successfully!`);
                }
            }
            document.getElementById('bookingForm').reset();
            toggleRecurringOptions();
            await displayBookings();
            await calendar.renderCalendar();
            await updateDashboard();
        } catch (error) {
            console.error("Failed to add booking(s):", error);
            alert("An error occurred while adding the booking. Please check the console for details.");
        }
    }

    async function deleteBooking(id){ if(confirm("Are you sure you want to delete this booking?")){ await db.deleteBooking(id); await displayBookings(); await calendar.renderCalendar(); await updateDashboard(); } }

    async function updateDashboard() { /* ... unchanged ... */ }
    async function setupBookingFilters() { /* ... unchanged ... */ }
    function clearBookingFilters() { /* ... unchanged ... */ }

    async function displayBookings(){
        const clientFilter = document.getElementById('filterClientName').value.toLowerCase();
        const pitchFilter = document.getElementById('filterPitch').value;
        const monthFilter = document.getElementById('filterMonth').value;
        const yearFilter = document.getElementById('filterYear').value;
        
        let filteredBookings = await db.getAllBookings();

        if (clientFilter) {
            filteredBookings = filteredBookings.filter(b => b.clientName.toLowerCase().includes(clientFilter));
        }
        if (pitchFilter !== "") {
            filteredBookings = filteredBookings.filter(b => b.pitch === pitchFilter);
        }
        if (monthFilter !== "") {
            filteredBookings = filteredBookings.filter(b => new Date(b.date).getMonth() == monthFilter);
        }
        if (yearFilter !== "") {
            filteredBookings = filteredBookings.filter(b => new Date(b.date).getFullYear() == yearFilter);
        }

        const tbody=document.getElementById("bookingsTableBody");
        if(!filteredBookings.length){
            tbody.innerHTML="<tr><td colspan=10>No bookings match the current filters.</td></tr>";
            return;
        }
        tbody.innerHTML=filteredBookings.map(b=>`
            <tr>
                <td>${b.pitch}</td><td>${b.clientName}</td><td>${b.date}</td><td>${b.startTime}</td>
                <td>${b.endTime}</td><td>${b.hours.toFixed(2)}h</td><td>${b.pricePerHour.toFixed(2)}</td><td>${b.totalPayment.toFixed(2)}</td>
                <td>${b.contact}</td>
                <td><button class="delete-btn" data-id="${b.id}">Delete</button></td>
            </tr>`).join("");
    }
    
    function switchTab(tabName){ /* ... unchanged ... */ }
    async function exportToExcel() { /* ... unchanged ... */ }
    async function handleFileUpload(event) { /* ... unchanged ... */ }
    class CalendarController{ /* ... unchanged ... */ }
    const calendar = new CalendarController();
    
    if (localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true') {
        showApp();
    } else {
        document.getElementById('login-screen').style.display = 'flex';
    }
    
    // Attach all event listeners using JavaScript
    // ... all event listeners are the same as the previous correct version ...
});
</script>
</body>
</html>
