<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Pitch Booking System</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height:100vh;
            padding:20px;
        }
        .container {
            max-width:1400px;
            margin:0 auto;
            background:white;
            border-radius:20px;
            box-shadow:0 20px 60px rgba(0,0,0,0.1);
            overflow:hidden;
        }
        .header {
            background:linear-gradient(135deg, #2c3e50, #34495e);
            color:white; padding:30px; text-align:center; position:relative;
        }
        .header h1 { font-size:2.5em; margin-bottom:10px; }
        .header-btn {
            background:rgba(255,255,255,0.2);
            border:2px solid rgba(255,255,255,0.3);
            color:white; padding:10px 20px; border-radius:25px;
            cursor:pointer; font-size:14px; font-weight:600;
        }
        .export-btn { position:absolute; top:20px; right:20px; }
        .import-btn { position:absolute; top:20px; right:150px; }
        .signout-btn {
            position:absolute; top:20px; left:20px; background:#dc3545;
        }
        .tabs { display:flex; background:#f8f9fa; border-bottom:3px solid #e9ecef; }
        .tab { flex:1; padding:20px; text-align:center; background:#e9ecef; cursor:pointer; font-weight:bold; }
        .tab.active { background:white; color:#2c3e50; }
        .content { padding:30px; }
        .booking-form, .filter-bar { background:#f8f9fa; padding:20px; border-radius:15px; margin-bottom:30px; }
        .form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:20px; }
        .form-group { display:flex; flex-direction:column; }
        .form-group label { font-weight:600; margin-bottom:8px; }
        .form-group input, .form-group select { padding:12px; border:2px solid #e9ecef; border-radius:10px; }
        #yearFilter, #repeatClientMonthFilter, #repeatClientYearFilter, #pitchRevenueMonthFilter, #pitchRevenueYearFilter { padding: 5px 10px; border-radius: 8px; border: 1px solid #ddd; background-color: white; }
        .calculated-field { background:#f8f9fa !important; font-weight:600; }
        .btn { padding:12px 20px; background:linear-gradient(135deg, #667eea, #764ba2); color:white; border:none; border-radius:25px; cursor:pointer; font-weight:600; }
        .btn:hover { opacity:0.9; }
        .booking-table { margin-top:20px; border-radius:15px; overflow:hidden; }
        .booking-table table { width:100%; border-collapse:collapse; }
        .booking-table th { background:#34495e; color:white; padding:15px; }
        .booking-table td { padding:12px; border-bottom:1px solid #eee; }
        .delete-btn { background:#dc3545; color:white; border:none; padding:8px 12px; border-radius:20px; cursor:pointer; }
        .dashboard-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; }
        .dashboard-card { background:#f9f9f9; padding:20px; border-radius:15px; }
        .card-title { font-weight:bold; margin-bottom:10px; }
        .metric { background:#667eea; color:white; border-radius:10px; padding:15px; text-align:center; }
        .metric-value { font-size:2em; font-weight:bold; }
        .empty-state { text-align:center; color:#666; padding:20px; }
        #calendarGrid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
        #calendarGrid div { background:#fff; border:1px solid #ddd; border-radius:10px; padding:5px; min-height:80px; }
        .filter-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: end; }
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none; align-items: center; justify-content: center;
            z-index: 2000; padding: 20px;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-box h2 { margin-bottom: 10px; color: #2c3e50; }
        .login-box .form-group { text-align: left; margin-bottom: 20px; }
        .login-options { display: flex; align-items: center; justify-content: center; margin-bottom: 25px; gap: 8px; color: #555; }
        #login-error { color: #dc3545; margin-top: 15px; font-weight: 600; display: none; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2>âš½ Login</h2>
            <p style="color:#777; margin-bottom:25px;">EP Sports Booking System</p>
            <div class="form-group">
                <label for="username">Username</label>
                <input id="username" type="text">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input id="password" type="password">
            </div>
            <div class="login-options">
                <input type="checkbox" id="keepLoggedIn" style="width:auto;">
                <label for="keepLoggedIn">Keep me logged in</label>
            </div>
            <button class="btn" onclick="handleLogin()">Login</button>
            <p id="login-error">Invalid username or password.</p>
        </div>
    </div>

    <div id="app-wrapper" style="display:none;">
        <div class="container">
            <div class="header">
                <button class="header-btn signout-btn" onclick="signOut()">Sign Out</button>
                <h1>âš½ Football Pitch Booking System</h1>
                <p>Manage your pitch rentals and track revenue</p>
                <input type="file" id="importFile" style="display:none;" accept=".xlsx, .xls" onchange="handleFileUpload(event)">
                <button class="header-btn import-btn" onclick="document.getElementById('importFile').click()">ðŸ“¥ Import</button>
                <button class="header-btn export-btn" onclick="exportToExcel()">ðŸ“Š Export</button>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('bookings')">ðŸ“‹ Bookings</div>
                <div class="tab" onclick="switchTab('dashboard')">ðŸ“Š Dashboard</div>
                <div class="tab" onclick="switchTab('calendar')">ðŸ“… Calendar</div>
            </div>

            <div class="content">
                <div id="bookings-content" class="tab-content">
                    <form id="bookingForm" class="booking-form">
                        <h2>Add New Booking</h2>
                        <div class="form-row">
                            <div class="form-group"><label>Pitch *</label>
                                <select id="pitch">
                                    <option value="">Select</option>
                                    <option>Fifa Pitch</option>
                                    <option>Junior Football Pitch</option>
                                    <option>Airdome</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Client *</label><input id="clientName"></div>
                            <div class="form-group"><label>Contact *</label><input id="contact"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Date *</label><input type="date" id="bookingDate"></div>
                            <div class="form-group"><label>Start *</label><input type="time" id="startTime"></div>
                            <div class="form-group"><label>End *</label><input type="time" id="endTime"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Price/hr *</label><input type="number" id="pricePerHour"></div>
                            <div class="form-group"><label>Total Hours</label><input id="totalHours" class="calculated-field" readonly></div>
                            <div class="form-group"><label>Total Payment</label><input id="totalPayment" class="calculated-field" readonly></div>
                        </div>
                        <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                        <div class="form-row">
                             <div class="form-group">
                                <label>Recurring</label>
                                <select id="recurringType" onchange="toggleRecurringOptions()">
                                    <option value="none">None</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group" id="recurring-options" style="display:none;">
                                <label>Repeat for how many times?</label>
                                <input type="number" id="recurringCount" min="1" value="4">
                            </div>
                        </div>
                        <button class="btn" type="button" onclick="addBooking()">Add Booking(s)</button>
                    </form>

                    <div class="filter-bar">
                        <div class="form-group">
                            <label>Filter by Client Name</label>
                            <input type="text" id="filterClientName" placeholder="Enter client name...">
                        </div>
                        <div class="form-group">
                            <label>Filter by Pitch</label>
                            <select id="filterPitch"></select>
                        </div>
                        <div class="form-group">
                            <label>Filter by Month</label>
                            <select id="filterMonth"></select>
                        </div>
                        <div class="form-group">
                            <label>Filter by Year</label>
                            <select id="filterYear"></select>
                        </div>
                        <button class="btn" onclick="clearBookingFilters()">Clear</button>
                    </div>

                    <div class="booking-table"><table><thead><tr>
                        <th>Pitch</th><th>Client</th><th>Date</th><th>Start</th><th>End</th><th>Hours</th><th>Rate</th><th>Total</th><th>Contact</th><th>Action</th>
                    </tr></thead><tbody id="bookingsTableBody"></tbody></table></div>
                </div>

                <div id="dashboard-content" class="tab-content" style="display:none;">
                    <div class="dashboard-grid">
                        <div class="dashboard-card"><div class="card-title">Total Revenue</div><div class="metric"><div id="totalRevenue" class="metric-value">AED 0.00</div></div></div>
                        <div class="dashboard-card"><div class="card-title">This Month's Revenue</div><div class="metric"><div id="monthlyRevenue" class="metric-value">AED 0.00</div></div></div>
                        <div class="dashboard-card"><div class="card-title">This Year's Revenue</div><div class="metric"><div id="yearlyRevenue" class="metric-value">AED 0.00</div></div></div>
                        <div class="dashboard-card"><div class="card-title">Total Bookings</div><div class="metric"><div id="totalBookingsCount" class="metric-value">0</div></div></div>
                        
                        <div class="dashboard-card">
                             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div class="card-title" style="margin-bottom: 0;">Revenue by Pitch</div>
                                <div style="display: flex; gap: 10px;">
                                    <select id="pitchRevenueMonthFilter"></select>
                                    <select id="pitchRevenueYearFilter"></select>
                                </div>
                            </div>
                            <div id="pitchRevenueBreakdown"><div class="empty-state">No revenue data.</div></div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div class="card-title" style="margin-bottom: 0;">Repeat Client Revenue</div>
                                <div style="display: flex; gap: 10px;">
                                    <select id="repeatClientMonthFilter"></select>
                                    <select id="repeatClientYearFilter"></select>
                                </div>
                            </div>
                            <div id="repeatClientRevenue"><div class="empty-state">No repeat clients for this period.</div></div>
                        </div>
                        
                        <div class="dashboard-card" style="grid-column: 1 / -1; min-height: 400px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div class="card-title" style="margin-bottom: 0;">Monthly Revenue Breakdown</div>
                                <select id="yearFilter"></select>
                            </div>
                            <div style="position: relative; height: 320px;">
                                <canvas id="monthlyRevenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="calendar-content" class="tab-content" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <button class="btn" onclick="navigateMonth(-1)">â¬… Prev</button>
                        <h2 id="calendarMonth"></h2>
                        <button class="btn" onclick="navigateMonth(1)">Next âž¡</button>
                        <button class="btn" onclick="goToToday()">Today</button>
                    </div>
                    <div id="calendarGrid"></div>
                </div>
            </div>
        </div>

        <div id="bookingDetailsPanel" style="display:none; position:fixed; top:0; right:0; width:350px; height:100%; background:white; box-shadow:-5px 0 15px rgba(0,0,0,0.2); padding:20px; overflow-y:auto; z-index:1000;">
            <button onclick="closeBookingDetails()" style="background:#dc3545; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">âœ– Close</button>
            <h3 style="margin:15px 0;">Booking Details</h3>
            <div id="bookingDetailsContent"></div>
        </div>
    </div>

<script>
// --- START: FIREBASE SETUP ---
// PASTE YOUR FIREBASE CONFIG OBJECT HERE
const firebaseConfig = {
    apiKey: "AIzaSyA9bEKptoXnOyUpZN-e2bZRrt15CWNLVvY",
    authDomain: "pitchbookingsystem-6e222.firebaseapp.com",
    projectId: "pitchbookingsystem-6e222",
    storageBucket: "pitchbookingsystem-6e222.firebasestorage.app",
    messagingSenderId: "486051720706",
    appId: "1:486051720706:web:2bbb83988fc6d623c1011b",
    measurementId: "G-PT7QJYP2T1"
  };


// Initialize Firebase
if (firebaseConfig.apiKey.startsWith("PASTE_YOUR")) {
    document.body.innerHTML = '<h1>Firebase configuration is missing. Please paste your firebaseConfig object in the script.</h1>';
    console.error("Firebase config object not found.");
} else {
    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();
}
// --- END: FIREBASE SETUP ---

// --- Authentication & Session Management ---
let inactivityTimer;
function handleLogin() {
    const user = document.getElementById('username').value;
    const pass = document.getElementById('password').value;
    const keepLoggedIn = document.getElementById('keepLoggedIn').checked;
    const errorEl = document.getElementById('login-error');
    if (user === "EPsports2025" && pass === "EPsport@25") {
        const storage = keepLoggedIn ? localStorage : sessionStorage;
        storage.setItem('isLoggedIn', 'true');
        errorEl.style.display = 'none';
        showApp();
    } else {
        errorEl.style.display = 'block';
    }
}
function signOut() {
    sessionStorage.removeItem('isLoggedIn');
    localStorage.removeItem('isLoggedIn');
    location.reload();
}
function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(signOut, 3 * 60 * 60 * 1000);
}
async function showApp() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-wrapper').style.display = 'block';
    await setupBookingFilters();
    await displayBookings(); 
    await calendar.renderCalendar(); 
    await updateDashboard();
    resetInactivityTimer();
    ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => 
        window.addEventListener(event, resetInactivityTimer)
    );
}

// --- Main Application ---
const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

function toggleRecurringOptions() {
    const type = document.getElementById('recurringType').value;
    document.getElementById('recurring-options').style.display = (type === 'none') ? 'none' : 'block';
}

class FirebaseDB {
    constructor() {
        this.bookingsCollection = firestore.collection("bookings");
    }
    async getAllBookings() {
        const snapshot = await this.bookingsCollection.orderBy("date").get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }
    async addBooking(data) {
        const hours = (new Date(`1970-01-01T${data.endTime}`) - new Date(`1970-01-01T${data.startTime}`)) / (1000 * 60 * 60);
        const newBooking = { ...data, hours, totalPayment: hours * data.pricePerHour };
        const docRef = await this.bookingsCollection.add(newBooking);
        return { id: docRef.id, ...newBooking };
    }
    async deleteBooking(id) {
        await this.bookingsCollection.doc(id).delete();
    }
}
const db = new FirebaseDB();
let monthlyRevenueChart;

async function isConflict(bookingData) {
    const newStart = new Date(`1970-01-01T${bookingData.startTime}`);
    const newEnd = new Date(`1970-01-01T${bookingData.endTime}`);
    const querySnapshot = await firestore.collection("bookings")
        .where("pitch", "==", bookingData.pitch)
        .where("date", "==", bookingData.date)
        .get();
    if (querySnapshot.empty) return false;
    for (const doc of querySnapshot.docs) {
        const existingBooking = doc.data();
        const existingStart = new Date(`1970-01-01T${existingBooking.startTime}`);
        const existingEnd = new Date(`1970-01-01T${existingBooking.endTime}`);
        if (newStart < existingEnd && newEnd > existingStart) return true;
    }
    return false;
}

async function addBooking(){
    const data = {
        pitch: document.getElementById("pitch").value, clientName: document.getElementById("clientName").value,
        contact: document.getElementById("contact").value, date: document.getElementById("bookingDate").value,
        startTime: document.getElementById("startTime").value, endTime: document.getElementById("endTime").value,
        pricePerHour: parseFloat(document.getElementById("pricePerHour").value)
    };
    if(!data.pitch || !data.clientName || !data.contact || !data.date || !data.startTime || !data.endTime || !data.pricePerHour){
        alert("Please fill all required fields."); return;
    }
    if (new Date(`1970-01-01T${data.startTime}`) >= new Date(`1970-01-01T${data.endTime}`)) {
        alert("Error: Start time must be before the end time."); return;
    }
    const recurringType = document.getElementById('recurringType').value;
    const recurringCount = parseInt(document.getElementById('recurringCount').value, 10);
    if (recurringType === 'none') {
        if (await isConflict(data)) {
            alert(`Booking Conflict: The selected time on ${data.pitch} for ${data.date} is unavailable.`); return;
        }
        await db.addBooking(data);
        alert("Booking added successfully!");
    } else {
        if (!recurringCount || recurringCount < 1) {
            alert('Please enter a valid number of repetitions.'); return;
        }
        if (recurringCount > 10 && !confirm(`This will create ${recurringCount} bookings. Are you sure?`)) return;
        const potentialBookings = [];
        const conflicts = [];
        const [year, month, day] = data.date.split('-').map(Number);
        const initialUTCDate = new Date(Date.UTC(year, month - 1, day));
        for (let i = 0; i < recurringCount; i++) {
            const newBookingData = { ...data };
            const nextDate = new Date(initialUTCDate);
            if (recurringType === 'weekly') nextDate.setUTCDate(initialUTCDate.getUTCDate() + (i * 7));
            else if (recurringType === 'monthly') nextDate.setUTCMonth(initialUTCDate.getUTCMonth() + i);
            newBookingData.date = nextDate.toISOString().slice(0, 10);
            if (await isConflict(newBookingData)) conflicts.push(newBookingData.date);
            potentialBookings.push(newBookingData);
        }
        if (conflicts.length > 0) {
            alert(`Booking Conflict Found:\nUnavailable dates for ${data.pitch}:\n\n${conflicts.join('\n')}\n\nNo bookings were added.`);
            return;
        } else {
            for(const booking of potentialBookings) { await db.addBooking(booking); }
            alert(`${recurringCount} recurring bookings added successfully!`);
        }
    }
    document.getElementById('bookingForm').reset();
    toggleRecurringOptions();
    await displayBookings();
    await calendar.renderCalendar();
    await updateDashboard();
}

async function updateDashboard() {
    const bookings = await db.getAllBookings();
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const uniqueYears = [...new Set(bookings.map(b => new Date(b.date).getFullYear()))].sort((a, b) => b - a);
    if (uniqueYears.length === 0) { uniqueYears.push(currentYear); }
    
    const allFilters = [
        { el: document.getElementById('yearFilter'), val: 'chartYear', type: 'year' },
        { el: document.getElementById('repeatClientMonthFilter'), val: 'repeatMonth', type: 'month' },
        { el: document.getElementById('repeatClientYearFilter'), val: 'repeatYear', type: 'year' },
        { el: document.getElementById('pitchRevenueMonthFilter'), val: 'pitchMonth', type: 'month' },
        { el: document.getElementById('pitchRevenueYearFilter'), val: 'pitchYear', type: 'year' },
    ];
    
    const selectedVals = allFilters.reduce((acc, f) => ({...acc, [f.val]: f.el.value}), {});

    allFilters.forEach(filter => {
        if (filter.type === 'month' && filter.el.options.length === 0) {
            monthNames.forEach((month, index) => filter.el.innerHTML += `<option value="${index}">${month}</option>`);
        } else if (filter.type === 'year') {
            filter.el.innerHTML = '';
            uniqueYears.forEach(year => filter.el.innerHTML += `<option value="${year}">${year}</option>`);
        }
    });

    document.getElementById('yearFilter').value = selectedVals.chartYear && uniqueYears.includes(parseInt(selectedVals.chartYear)) ? selectedVals.chartYear : uniqueYears[0];
    document.getElementById('repeatClientMonthFilter').value = selectedVals.repeatMonth || currentMonth;
    document.getElementById('repeatClientYearFilter').value = selectedVals.repeatYear && uniqueYears.includes(parseInt(selectedVals.repeatYear)) ? selectedVals.repeatYear : currentYear;
    document.getElementById('pitchRevenueMonthFilter').value = selectedVals.pitchMonth || currentMonth;
    document.getElementById('pitchRevenueYearFilter').value = selectedVals.pitchYear && uniqueYears.includes(parseInt(selectedVals.pitchYear)) ? selectedVals.pitchYear : currentYear;
    
    document.getElementById('totalRevenue').textContent = `AED ${bookings.reduce((s, b) => s + b.totalPayment, 0).toFixed(2)}`;
    document.getElementById('monthlyRevenue').textContent = `AED ${bookings.filter(b => { const d = new Date(b.date); return d.getFullYear() === currentYear && d.getMonth() === currentMonth; }).reduce((s, b) => s + b.totalPayment, 0).toFixed(2)}`;
    document.getElementById('yearlyRevenue').textContent = `AED ${bookings.filter(b => new Date(b.date).getFullYear() === currentYear).reduce((s, b) => s + b.totalPayment, 0).toFixed(2)}`;
    document.getElementById('totalBookingsCount').textContent = bookings.length;

    const yearForPitch = parseInt(document.getElementById('pitchRevenueYearFilter').value);
    const monthForPitch = parseInt(document.getElementById('pitchRevenueMonthFilter').value);
    const filteredForPitch = bookings.filter(b => { const d = new Date(b.date); return d.getFullYear() === yearForPitch && d.getMonth() === monthForPitch; });
    const pitchRevenue = filteredForPitch.reduce((acc, b) => { acc[b.pitch] = (acc[b.pitch] || 0) + b.totalPayment; return acc; }, {});
    document.getElementById('pitchRevenueBreakdown').innerHTML = Object.keys(pitchRevenue).length === 0 ? `<div class="empty-state">No revenue data for this period.</div>` : Object.entries(pitchRevenue).map(([pitch, revenue]) => `<div style="padding: 6px 0; display:flex; justify-content:space-between; border-bottom: 1px solid #eee;"><strong>${pitch}:</strong> <span>AED ${revenue.toFixed(2)}</span></div>`).join('');

    const yearForRepeat = parseInt(document.getElementById('repeatClientYearFilter').value);
    const monthForRepeat = parseInt(document.getElementById('repeatClientMonthFilter').value);
    const filteredForRepeat = bookings.filter(b => { const d = new Date(b.date); return d.getFullYear() === yearForRepeat && d.getMonth() === monthForRepeat; });
    const bookingsByClient = filteredForRepeat.reduce((acc, b) => { acc[b.clientName] = acc[b.clientName] || []; acc[b.clientName].push(b); return acc; }, {});
    const repeatClientRevenue = Object.entries(bookingsByClient).filter(([, b]) => b.length > 1).reduce((acc, [name, b]) => { acc[name] = b.reduce((s, i) => s + i.totalPayment, 0); return acc; }, {});
    document.getElementById('repeatClientRevenue').innerHTML = Object.keys(repeatClientRevenue).length === 0 ? `<div class="empty-state">No repeat clients for this period.</div>` : Object.entries(repeatClientRevenue).sort(([, a], [, b]) => b - a).map(([c, r]) => `<div style="padding: 6px 0; display:flex; justify-content:space-between; border-bottom: 1px solid #eee;"><strong>${c}:</strong> <span>AED ${r.toFixed(2)}</span></div>`).join('');

    const selectedYearForChart = parseInt(document.getElementById('yearFilter').value);
    const monthlyData = Array(12).fill(0);
    bookings.filter(b => new Date(b.date).getFullYear() === selectedYearForChart).forEach(b => { monthlyData[new Date(b.date).getMonth()] += b.totalPayment; });
    
    if (monthlyRevenueChart) {
        monthlyRevenueChart.data.datasets[0].data = monthlyData;
        monthlyRevenueChart.update();
    } else {
        monthlyRevenueChart = new Chart(document.getElementById('monthlyRevenueChart').getContext('2d'), { type: 'bar', data: { labels: monthNames.map(m => m.slice(0,3)), datasets: [{ label: `Revenue for ${selectedYearForChart}`, data: monthlyData, backgroundColor: 'rgba(102, 126, 234, 0.6)', borderColor: 'rgba(102, 126, 234, 1)', borderWidth: 1, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: value => `AED ${value}` } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: context => ` Revenue: AED ${context.raw.toFixed(2)}` } } } } });
    }
}

async function setupBookingFilters() {
    const pitchFilter = document.getElementById('filterPitch');
    const monthFilter = document.getElementById('filterMonth');
    const yearFilter = document.getElementById('filterYear');
    const uniquePitches = ['Fifa Pitch', 'Junior Football Pitch', 'Airdome'];
    const bookings = await db.getAllBookings();
    const uniqueYears = [...new Set(bookings.map(b => new Date(b.date).getFullYear()))].sort((a, b) => b - a);
    pitchFilter.innerHTML = '<option value="">All Pitches</option>';
    uniquePitches.forEach(p => pitchFilter.innerHTML += `<option value="${p}">${p}</option>`);
    monthFilter.innerHTML = '<option value="">All Months</option>';
    monthNames.forEach((m, i) => monthFilter.innerHTML += `<option value="${i}">${m}</option>`);
    yearFilter.innerHTML = '<option value="">All Years</option>';
    uniqueYears.forEach(y => yearFilter.innerHTML += `<option value="${y}">${y}</option>`);
}

function clearBookingFilters() {
    document.getElementById('filterClientName').value = '';
    document.getElementById('filterPitch').value = '';
    document.getElementById('filterMonth').value = '';
    document.getElementById('filterYear').value = '';
    displayBookings();
}

async function displayBookings(){
    const clientFilter = document.getElementById('filterClientName').value.toLowerCase();
    const pitchFilter = document.getElementById('filterPitch').value;
    const monthFilter = document.getElementById('filterMonth').value;
    const yearFilter = document.getElementById('filterYear').value;
    let filteredBookings = await db.getAllBookings();
    if (clientFilter) filteredBookings = filteredBookings.filter(b => b.clientName.toLowerCase().includes(clientFilter));
    if (pitchFilter) filteredBookings = filteredBookings.filter(b => b.pitch === pitchFilter);
    if (monthFilter !== "") filteredBookings = filteredBookings.filter(b => new Date(b.date).getMonth() == monthFilter);
    if (yearFilter) filteredBookings = filteredBookings.filter(b => new Date(b.date).getFullYear() == yearFilter);
    const tbody=document.getElementById("bookingsTableBody");
    if(!filteredBookings.length){
        tbody.innerHTML="<tr><td colspan=10>No bookings match the current filters.</td></tr>";
        return;
    }
    tbody.innerHTML=filteredBookings.map(b=>`
        <tr>
            <td>${b.pitch}</td><td>${b.clientName}</td><td>${b.date}</td><td>${b.startTime}</td>
            <td>${b.endTime}</td><td>${b.hours.toFixed(2)}h</td><td>${b.pricePerHour.toFixed(2)}</td><td>${b.totalPayment.toFixed(2)}</td>
            <td>${b.contact}</td>
            <td><button class="delete-btn" onclick="deleteBooking('${b.id}')">Delete</button></td>
        </tr>`).join("");
}
async function deleteBooking(id){ if(confirm("Are you sure you want to delete this booking?")){ await db.deleteBooking(id); await displayBookings(); await calendar.renderCalendar(); await updateDashboard(); } }
function switchTab(tab){ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none'); event.target.classList.add('active'); document.getElementById(tab+'-content').style.display='block'; if(tab==='calendar')calendar.renderCalendar(); if(tab==='dashboard')updateDashboard(); }

async function exportToExcel() {
    const bookings = await db.getAllBookings();
    if (bookings.length === 0) { alert("No booking data to export."); return; }
    const exportData = bookings.map(b => ({ 'Pitch': b.pitch, 'Client Name': b.clientName, 'Date': b.date, 'Start Time': b.startTime, 'End Time': b.endTime, 'Total Hours': b.hours, 'Price Per Hour (AED)': b.pricePerHour, 'Total Payment (AED)': b.totalPayment, 'Contact': b.contact }));
    const worksheet = XLSX.utils.json_to_sheet(exportData);
    worksheet['!cols'] = Object.keys(exportData[0]).map(key => ({ wch: Math.max(...exportData.map(row => String(row[key] || "").length), key.length) + 2 }));
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Bookings");
    XLSX.writeFile(workbook, `Football_Pitch_Bookings_${new Date().toISOString().slice(0, 10)}.xlsx`);
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            let successCount = 0, conflictCount = 0, invalidCount = 0;
            for (const row of jsonData) {
                const bookingData = {
                    pitch: row['Pitch'], clientName: row['Client Name'], contact: row['Contact'],
                    date: row['Date'], startTime: row['Start Time'], endTime: row['End Time'],
                    pricePerHour: parseFloat(row['Price Per Hour (AED)']) || parseFloat(row['Price Per Hour'])
                };
                if (Object.values(bookingData).some(v => v === undefined) || isNaN(bookingData.pricePerHour)) {
                    invalidCount++; continue;
                }
                if (await isConflict(bookingData)) {
                    conflictCount++; continue;
                }
                await db.addBooking(bookingData);
                successCount++;
            }
            alert(`Import Complete:\n- ${successCount} bookings added.\n- ${conflictCount} conflicts found.\n- ${invalidCount} invalid rows skipped.`);
            await displayBookings(); await updateDashboard(); await calendar.renderCalendar();
        } catch (error) {
            console.error("Error processing Excel file:", error);
            alert("Error processing file. Please ensure columns are named correctly (e.g., 'Client Name', 'Start Time').");
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsArrayBuffer(file);
}

class CalendarController{
    constructor(){
        this.currentDate = new Date();
        this.clientColorMap = new Map();
    }
    getClientColor(clientName) {
        if (!this.clientColorMap.has(clientName)) {
            const hue = Math.floor(Math.random() * 360);
            this.clientColorMap.set(clientName, `hsl(${hue}, 75%, 50%)`);
        }
        return this.clientColorMap.get(clientName);
    }
    async renderCalendar(){
        const year=this.currentDate.getFullYear(), month=this.currentDate.getMonth();
        document.getElementById("calendarMonth").textContent=this.currentDate.toLocaleString('default',{month:'long',year:'numeric'});
        const grid=document.getElementById("calendarGrid");
        grid.innerHTML="";
        ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>{let div=document.createElement("div");div.style.fontWeight="bold";div.textContent=d;grid.appendChild(div);});
        for(let i=0;i<new Date(year,month,1).getDay();i++){grid.appendChild(document.createElement("div"));}
        const allBookings = await db.getAllBookings();
        for(let day=1;day<=new Date(year,month+1,0).getDate();day++){
            const cell=document.createElement("div"); cell.innerHTML=`<div style='font-weight:600;'>${day}</div>`;
            const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            allBookings.filter(b=>b.date===dateStr).forEach(b=>{
                const div=document.createElement("div");
                div.style.cssText=`background-color:${this.getClientColor(b.clientName)};color:white;padding:2px 4px;margin:2px 0;border-radius:4px;cursor:pointer;font-size:12px`;
                div.textContent=`${b.startTime}-${b.endTime} ${b.clientName}`;
                div.onclick=()=>this.showBookingDetails(b);
                cell.appendChild(div);
            });
            grid.appendChild(cell);
        }
    }
    navigateMonth(d){ this.currentDate.setMonth(this.currentDate.getMonth()+d); this.renderCalendar(); }
    goToToday(){ this.currentDate=new Date(); this.renderCalendar(); }
    showBookingDetails(b){
        document.getElementById("bookingDetailsContent").innerHTML=`
            <p><b>Pitch:</b> ${b.pitch}</p><p><b>Client:</b> ${b.clientName}</p><p><b>Contact:</b> ${b.contact}</p>
            <p><b>Date:</b> ${b.date}</p><p><b>Time:</b> ${b.startTime}-${b.endTime}</p>
            <p><b>Total Hours:</b> ${b.hours.toFixed(2)}</p><p><b>Total:</b> AED ${b.totalPayment.toFixed(2)}</p>
            <hr><button onclick="deleteBookingFromCalendar('${b.id}')" style="background:#dc3545;color:white;padding:10px;border:none;border-radius:5px;">Delete</button>`;
        document.getElementById("bookingDetailsPanel").style.display="block";
    }
}
const calendar=new CalendarController();
function navigateMonth(d){calendar.navigateMonth(d);} function goToToday(){calendar.goToToday();}
function closeBookingDetails(){document.getElementById("bookingDetailsPanel").style.display="none";}
async function deleteBookingFromCalendar(id){ await deleteBooking(id); closeBookingDetails(); }

document.addEventListener("DOMContentLoaded",()=>{ 
    if (localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true') {
        showApp();
    } else {
        document.getElementById('login-screen').style.display = 'flex';
    }
    document.getElementById('yearFilter').addEventListener('change', updateDashboard);
    document.getElementById('repeatClientMonthFilter').addEventListener('change', updateDashboard);
    document.getElementById('repeatClientYearFilter').addEventListener('change', updateDashboard);
    document.getElementById('pitchRevenueMonthFilter').addEventListener('change', updateDashboard);
    document.getElementById('pitchRevenueYearFilter').addEventListener('change', updateDashboard);
    document.getElementById('filterClientName').addEventListener('input', displayBookings);
    document.getElementById('filterPitch').addEventListener('change', displayBookings);
    document.getElementById('filterMonth').addEventListener('change', displayBookings);
    document.getElementById('filterYear').addEventListener('change', displayBookings);
    document.getElementById('password').addEventListener('keypress', function(e){ if (e.key === 'Enter') handleLogin(); });
});
</script>
</body>
</html>
