<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Pitch Booking System</title>
    
    <script src="firebase-config.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height:100vh;
            padding:20px;
        }
        .container { max-width:1400px; margin:0 auto; background:white; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.1); overflow:hidden; }
        .header { background:linear-gradient(135deg, #2c3e50, #34495e); color:white; padding:30px; text-align:center; position:relative; }
        .header h1 { font-size:2.5em; margin-bottom:10px; }
        .header-btn { background:rgba(255,255,255,0.2); border:2px solid rgba(255,255,255,0.3); color:white; padding:10px 20px; border-radius:25px; cursor:pointer; font-size:14px; font-weight:600; }
        .export-btn { position:absolute; top:20px; right:20px; }
        .import-btn { position:absolute; top:20px; right:150px; }
        .signout-btn { position:absolute; top:20px; left:20px; background:#dc3545; }
        .tabs { display:flex; background:#f8f9fa; border-bottom:3px solid #e9ecef; }
        .tab { flex:1; padding:20px; text-align:center; background:#e9ecef; cursor:pointer; font-weight:bold; }
        .tab.active { background:white; color:#2c3e50; }
        .content { padding:30px; }
        .booking-form, .filter-bar { background:#f8f9fa; padding:20px; border-radius:15px; margin-bottom:30px; }
        .form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:20px; }
        .form-group { display:flex; flex-direction:column; }
        .form-group label { font-weight:600; margin-bottom:8px; }
        .form-group input, .form-group select { padding:12px; border:2px solid #e9ecef; border-radius:10px; }
        #yearFilter, #repeatClientMonthFilter, #repeatClientYearFilter, #pitchRevenueMonthFilter, #pitchRevenueYearFilter { padding: 5px 10px; border-radius: 8px; border: 1px solid #ddd; background-color: white; }
        .calculated-field { background:#f8f9fa !important; font-weight:600; }
        .btn { padding:12px 20px; background:linear-gradient(135deg, #667eea, #764ba2); color:white; border:none; border-radius:25px; cursor:pointer; font-weight:600; }
        .btn:hover { opacity:0.9; }
        .booking-table { margin-top:20px; border-radius:15px; overflow:hidden; }
        .booking-table table { width:100%; border-collapse:collapse; }
        .booking-table th { background:#34495e; color:white; padding:15px; }
        .booking-table td { padding:12px; border-bottom:1px solid #eee; }
        .delete-btn { background:#dc3545; color:white; border:none; padding:8px 12px; border-radius:20px; cursor:pointer; }
        .dashboard-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; }
        .dashboard-card { background:#f9f9f9; padding:20px; border-radius:15px; }
        .card-title { font-weight:bold; margin-bottom:10px; }
        .metric { background:#667eea; color:white; border-radius:10px; padding:15px; text-align:center; }
        .metric-value { font-size:2em; font-weight:bold; }
        .empty-state { text-align:center; color:#666; padding:20px; }
        #calendarGrid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
        #calendarGrid div { background:#fff; border:1px solid #ddd; border-radius:10px; padding:5px; min-height:80px; }
        .filter-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: end; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center; }
        .login-box h2 { margin-bottom: 10px; color: #2c3e50; }
        .login-box .form-group { text-align: left; margin-bottom: 20px; }
        .login-options { display: flex; align-items: center; justify-content: center; margin-bottom: 25px; gap: 8px; color: #555; }
        #login-error { color: #dc3545; margin-top: 15px; font-weight: 600; display: none; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2>âš½ Login</h2>
            <p style="color:#777; margin-bottom:25px;">EP Sports Booking System</p>
            <div class="form-group">
                <label for="username">Username</label>
                <input id="username" type="text">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input id="password" type="password">
            </div>
            <div class="login-options">
                <input type="checkbox" id="keepLoggedIn" style="width:auto;">
                <label for="keepLoggedIn">Keep me logged in</label>
            </div>
            <button id="loginButton" class="btn">Login</button>
            <p id="login-error">Invalid username or password.</p>
        </div>
    </div>

    <div id="app-wrapper" style="display:none;">
        <div class="container">
            <div class="header">
                <button id="signOutButton" class="header-btn signout-btn">Sign Out</button>
                <h1>âš½ Football Pitch Booking System</h1>
                <p>Manage your pitch rentals and track revenue</p>
                <input type="file" id="importFile" style="display:none;" accept=".xlsx, .xls">
                <button id="importButton" class="header-btn import-btn">ðŸ“¥ Import</button>
                <button id="exportButton" class="header-btn export-btn">ðŸ“Š Export</button>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="bookings">ðŸ“‹ Bookings</div>
                <div class="tab" data-tab="dashboard">ðŸ“Š Dashboard</div>
                <div class="tab" data-tab="calendar">ðŸ“… Calendar</div>
            </div>

            <div class="content">
                <div id="bookings-content" class="tab-content">
                    <form id="bookingForm" class="booking-form">
                        <h2>Add New Booking</h2>
                        <div class="form-row">
                            <div class="form-group"><label>Pitch *</label>
                                <select id="pitch">
                                    <option value="">Select</option>
                                    <option>Fifa Pitch</option>
                                    <option>Junior Football Pitch</option>
                                    <option>Airdome</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Client *</label><input id="clientName"></div>
                            <div class="form-group"><label>Contact *</label><input id="contact"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Date *</label><input type="date" id="bookingDate"></div>
                            <div class="form-group"><label>Start *</label><input type="time" id="startTime"></div>
                            <div class="form-group"><label>End *</label><input type="time" id="endTime"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Price/hr *</label><input type="number" id="pricePerHour"></div>
                            <div class="form-group"><label>Total Hours</label><input id="totalHours" class="calculated-field" readonly></div>
                            <div class="form-group"><label>Total Payment</label><input id="totalPayment" class="calculated-field" readonly></div>
                        </div>
                        <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                        <div class="form-row">
                             <div class="form-group">
                                <label>Recurring</label>
                                <select id="recurringType">
                                    <option value="none">None</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group" id="recurring-options" style="display:none;">
                                <label>Repeat for how many times?</label>
                                <input type="number" id="recurringCount" min="1" value="4">
                            </div>
                        </div>
                        <button id="addBookingButton" class="btn" type="button">Add Booking(s)</button>
                    </form>

                    <div class="filter-bar">
                        <div class="form-group">
                            <label>Filter by Client Name</label>
                            <input type="text" id="filterClientName" placeholder="Enter client name...">
                        </div>
                        <div class="form-group">
                            <label>Filter by Pitch</label>
                            <select id="filterPitch"></select>
                        </div>
                        <div class="form-group">
                            <label>Filter by Month</label>
                            <select id="filterMonth"></select>
                        </div>
                        <div class="form-group">
                            <label>Filter by Year</label>
                            <select id="filterYear"></select>
                        </div>
                        <button id="clearFiltersButton" class="btn">Clear</button>
                    </div>

                    <div class="booking-table"><table><thead><tr>
                        <th>Pitch</th><th>Client</th><th>Date</th><th>Start</th><th>End</th><th>Hours</th><th>Rate</th><th>Total</th><th>Contact</th><th>Action</th>
                    </tr></thead><tbody id="bookingsTableBody"></tbody></table></div>
                </div>

                <div id="dashboard-content" class="tab-content" style="display:none;"></div>
                <div id="calendar-content" class="tab-content" style="display:none;"></div>
            </div>
        </div>

        <div id="bookingDetailsPanel" style="display:none;"></div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    
    let firestore;
    try {
        if (typeof firebaseConfig !== 'undefined' && firebaseConfig.apiKey && !firebaseConfig.apiKey.startsWith("PASTE_YOUR")) {
            firebase.initializeApp(firebaseConfig);
            firestore = firebase.firestore();
        } else {
            throw new Error("Firebase config object not found or is invalid.");
        }
    } catch (error) {
        console.error("Firebase initialization failed:", error);
        document.body.innerHTML = `<h1>Error: Could not initialize Firebase. Please ensure firebase-config.js is correct and Firebase SDKs are loaded.</h1>`;
        return;
    }

    let inactivityTimer;
    let monthlyRevenueChart;
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    function handleLogin() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        const keepLoggedIn = document.getElementById('keepLoggedIn').checked;
        const errorEl = document.getElementById('login-error');
        if (user === "EPsports2025" && pass === "EPsport@25") {
            const storage = keepLoggedIn ? localStorage : sessionStorage;
            storage.setItem('isLoggedIn', 'true');
            errorEl.style.display = 'none';
            showApp();
        } else {
            errorEl.style.display = 'block';
        }
    }

    function signOut() {
        sessionStorage.removeItem('isLoggedIn');
        localStorage.removeItem('isLoggedIn');
        location.reload();
    }

    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(signOut, 3 * 60 * 60 * 1000);
    }

    async function showApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-wrapper').style.display = 'block';
        await setupBookingFilters();
        await displayBookings(); 
        await calendar.renderCalendar(); 
        await updateDashboard();
        resetInactivityTimer();
        ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => 
            window.addEventListener(event, resetInactivityTimer)
        );
    }

    class FirebaseDB {
        constructor() { this.bookingsCollection = firestore.collection("bookings"); }
        async getAllBookings() {
            const snapshot = await this.bookingsCollection.orderBy("date").get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        async addBooking(data) {
            const hours = (new Date(`1970-01-01T${data.endTime}`) - new Date(`1970-01-01T${data.startTime}`)) / (1000 * 60 * 60);
            const newBooking = { ...data, hours, totalPayment: hours * data.pricePerHour };
            const docRef = await this.bookingsCollection.add(newBooking);
            return { id: docRef.id, ...newBooking };
        }
        async deleteBooking(id) { await this.bookingsCollection.doc(id).delete(); }
    }
    const db = new FirebaseDB();

    function toggleRecurringOptions() {
        const type = document.getElementById('recurringType').value;
        document.getElementById('recurring-options').style.display = (type === 'none') ? 'none' : 'block';
    }
    
    async function isConflict(bookingData) {
        try {
            const newStart = new Date(`1970-01-01T${bookingData.startTime}`);
            const newEnd = new Date(`1970-01-01T${bookingData.endTime}`);
            const querySnapshot = await firestore.collection("bookings")
                .where("pitch", "==", bookingData.pitch)
                .where("date", "==", bookingData.date)
                .get();
            if (querySnapshot.empty) return false;
            for (const doc of querySnapshot.docs) {
                const existingBooking = doc.data();
                const existingStart = new Date(`1970-01-01T${existingBooking.startTime}`);
                const existingEnd = new Date(`1970-01-01T${existingBooking.endTime}`);
                if (newStart < existingEnd && newEnd > existingStart) return true;
            }
            return false;
        } catch (error) {
            console.error("Error checking for conflicts:", error);
            alert("Could not check for booking conflicts. This might be due to missing database indexes. Please go to the Firebase console, select Firestore -> Indexes, and create a composite index for the 'bookings' collection with 'pitch' (Ascending) and 'date' (Ascending).");
            return true;
        }
    }

    async function addBooking(){
        try {
            const data = {
                pitch: document.getElementById("pitch").value, clientName: document.getElementById("clientName").value,
                contact: document.getElementById("contact").value, date: document.getElementById("bookingDate").value,
                startTime: document.getElementById("startTime").value, endTime: document.getElementById("endTime").value,
                pricePerHour: parseFloat(document.getElementById("pricePerHour").value)
            };
            if(!data.pitch || !data.clientName || !data.contact || !data.date || !data.startTime || !data.endTime || isNaN(data.pricePerHour)){
                alert("Please fill all required fields with valid data."); return;
            }
            if (new Date(`1970-01-01T${data.startTime}`) >= new Date(`1970-01-01T${data.endTime}`)) {
                alert("Error: Start time must be before the end time."); return;
            }
            const recurringType = document.getElementById('recurringType').value;
            const recurringCount = parseInt(document.getElementById('recurringCount').value, 10);
            if (recurringType === 'none') {
                if (await isConflict(data)) {
                    alert(`Booking Conflict: The selected time on ${data.pitch} for ${data.date} is unavailable.`); return;
                }
                await db.addBooking(data);
                alert("Booking added successfully!");
                location.reload(); // Refresh the page
            } else {
                if (!recurringCount || recurringCount < 1) {
                    alert('Please enter a valid number of repetitions.'); return;
                }
                if (recurringCount > 10 && !confirm(`This will create ${recurringCount} bookings. Are you sure?`)) return;
                
                const potentialBookings = [];
                const conflicts = [];
                const [year, month, day] = data.date.split('-').map(Number);
                const initialUTCDate = new Date(Date.UTC(year, month - 1, day));
                for (let i = 0; i < recurringCount; i++) {
                    const newBookingData = { ...data };
                    const nextDate = new Date(initialUTCDate);
                    if (recurringType === 'weekly') nextDate.setUTCDate(initialUTCDate.getUTCDate() + (i * 7));
                    else if (recurringType === 'monthly') nextDate.setUTCMonth(initialUTCDate.getUTCMonth() + i);
                    newBookingData.date = nextDate.toISOString().slice(0, 10);
                    if (await isConflict(newBookingData)) conflicts.push(newBookingData.date);
                    potentialBookings.push(newBookingData);
                }
                if (conflicts.length > 0) {
                    alert(`Booking Conflict Found:\nUnavailable dates for ${data.pitch}:\n\n${conflicts.join('\n')}\n\nNo bookings were added.`);
                    return;
                } else {
                    for(const booking of potentialBookings) { await db.addBooking(booking); }
                    alert(`${recurringCount} recurring bookings added successfully!`);
                    location.reload(); // Refresh the page
                }
            }
        } catch (error) {
            console.error("Failed to add booking(s):", error);
            alert("An error occurred while adding the booking. Please check the console for details.");
        }
    }

    async function deleteBooking(id){ if(confirm("Are you sure you want to delete this booking?")){ await db.deleteBooking(id); await displayBookings(); await calendar.renderCalendar(); await updateDashboard(); } }

    async function updateDashboard() { /* ... unchanged ... */ }
    async function setupBookingFilters() { /* ... unchanged ... */ }
    function clearBookingFilters() { /* ... unchanged ... */ }

    async function displayBookings(){
        const clientFilter = document.getElementById('filterClientName').value.toLowerCase();
        const pitchFilter = document.getElementById('filterPitch').value;
        const monthFilter = document.getElementById('filterMonth').value;
        const yearFilter = document.getElementById('filterYear').value;
        let filteredBookings = await db.getAllBookings();

        if (clientFilter !== "") filteredBookings = filteredBookings.filter(b => b.clientName.toLowerCase().includes(clientFilter));
        if (pitchFilter !== "") filteredBookings = filteredBookings.filter(b => b.pitch === pitchFilter);
        if (monthFilter !== "") filteredBookings = filteredBookings.filter(b => new Date(b.date).getMonth() == monthFilter);
        if (yearFilter !== "") filteredBookings = filteredBookings.filter(b => new Date(b.date).getFullYear() == yearFilter);

        const tbody = document.getElementById("bookingsTableBody");
        if(!filteredBookings.length){
            tbody.innerHTML="<tr><td colspan=10>No bookings match the current filters.</td></tr>";
            return;
        }
        tbody.innerHTML = filteredBookings.map(b=>`
            <tr>
                <td>${b.pitch}</td><td>${b.clientName}</td><td>${b.date}</td><td>${b.startTime}</td>
                <td>${b.endTime}</td><td>${b.hours.toFixed(2)}h</td><td>${b.pricePerHour.toFixed(2)}</td><td>${b.totalPayment.toFixed(2)}</td>
                <td>${b.contact}</td>
                <td><button class="delete-btn" data-id="${b.id}">Delete</button></td>
            </tr>`).join("");
    }
    
    function switchTab(tabName){ /* ... unchanged ... */ }
    async function exportToExcel() { /* ... unchanged ... */ }
    async function handleFileUpload(event) { /* ... unchanged ... */ }
    class CalendarController{ /* ... unchanged ... */ }
    const calendar = new CalendarController();
    
    // --- INITIAL APP STARTUP & EVENT LISTENERS ---
    if (localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true') {
        showApp();
    } else {
        document.getElementById('login-screen').style.display = 'flex';
    }
    
    document.getElementById('loginButton').addEventListener('click', handleLogin);
    document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
    document.getElementById('signOutButton').addEventListener('click', signOut);
    document.getElementById('importButton').addEventListener('click', () => document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', handleFileUpload);
    document.getElementById('exportButton').addEventListener('click', exportToExcel);

    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    document.getElementById('recurringType').addEventListener('change', toggleRecurringOptions);

    // Dashboard & Booking Filter Listeners...
    document.getElementById('yearFilter').addEventListener('change', updateDashboard);
    document.getElementById('repeatClientMonthFilter').addEventListener('change', updateDashboard);
    // ... and so on for all other listeners from the previous correct version
});
</script>
</body>
</html>
