<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Pitch Booking System</title>
    <script src="firebase-config.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height:100vh;
            padding:20px;
        }
        .container {
            max-width:1400px;
            margin:0 auto;
            background:white;
            border-radius:20px;
            box-shadow:0 20px 60px rgba(0,0,0,0.1);
            overflow:hidden;
        }
        .header {
            background:linear-gradient(135deg, #2c3e50, #34495e);
            color:white; padding:30px; text-align:center; position:relative;
        }
        .header h1 { font-size:2.5em; margin-bottom:10px; }
        .header-btn {
            background:rgba(255,255,255,0.2);
            border:2px solid rgba(255,255,255,0.3);
            color:white; padding:10px 20px; border-radius:25px;
            cursor:pointer; font-size:14px; font-weight:600;
        }
        .export-btn { position:absolute; top:20px; right:20px; }
        .import-btn { position:absolute; top:20px; right:150px; }
        .signout-btn {
            position:absolute; top:20px; left:20px; background:#dc3545;
        }
        .tabs { display:flex; background:#f8f9fa; border-bottom:3px solid #e9ecef; }
        .tab { flex:1; padding:20px; text-align:center; background:#e9ecef; cursor:pointer; font-weight:bold; }
        .tab.active { background:white; color:#2c3e50; }
        .content { padding:30px; }
        .booking-form, .filter-bar { background:#f8f9fa; padding:20px; border-radius:15px; margin-bottom:30px; }
        .form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:20px; }
        .form-group { display:flex; flex-direction:column; }
        .form-group label { font-weight:600; margin-bottom:8px; }
        .form-group input, .form-group select { padding:12px; border:2px solid #e9ecef; border-radius:10px; }
        #yearFilter, #repeatClientMonthFilter, #repeatClientYearFilter, #pitchRevenueMonthFilter, #pitchRevenueYearFilter { padding: 5px 10px; border-radius: 8px; border: 1px solid #ddd; background-color: white; }
        .calculated-field { background:#f8f9fa !important; font-weight:600; }
        .btn { padding:12px 20px; background:linear-gradient(135deg, #667eea, #764ba2); color:white; border:none; border-radius:25px; cursor:pointer; font-weight:600; }
        .btn:hover { opacity:0.9; }
        .booking-table { margin-top:20px; border-radius:15px; overflow:hidden; }
        .booking-table table { width:100%; border-collapse:collapse; }
        .booking-table th { background:#34495e; color:white; padding:15px; }
        .booking-table td { padding:12px; border-bottom:1px solid #eee; }
        .delete-btn { background:#dc3545; color:white; border:none; padding:8px 12px; border-radius:20px; cursor:pointer; }
        .dashboard-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; }
        .dashboard-card { background:#f9f9f9; padding:20px; border-radius:15px; }
        .card-title { font-weight:bold; margin-bottom:10px; }
        .metric { background:#667eea; color:white; border-radius:10px; padding:15px; text-align:center; }
        .metric-value { font-size:2em; font-weight:bold; }
        .empty-state { text-align:center; color:#666; padding:20px; }
        #calendarGrid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
        #calendarGrid div { background:#fff; border:1px solid #ddd; border-radius:10px; padding:5px; min-height:80px; }
        .filter-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: end; }
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none; align-items: center; justify-content: center;
            z-index: 2000; padding: 20px;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-box h2 { margin-bottom: 10px; color: #2c3e50; }
        .login-box .form-group { text-align: left; margin-bottom: 20px; }
        .login-options { display: flex; align-items: center; justify-content: center; margin-bottom: 25px; gap: 8px; color: #555; }
        #login-error { color: #dc3545; margin-top: 15px; font-weight: 600; display: none; }
    </style>
</head>
<body>
    <div id="login-screen"></div>
    <div id="app-wrapper" style="display:none;">
        <div class="container">
            <div class="header">
                <button class="header-btn signout-btn" onclick="signOut()">Sign Out</button>
                <h1>âš½ Football Pitch Booking System</h1>
                <p>Manage your pitch rentals and track revenue</p>
                <input type="file" id="importFile" style="display:none;" accept=".xlsx, .xls" onchange="handleFileUpload(event)">
                <button class="header-btn import-btn" onclick="document.getElementById('importFile').click()">ðŸ“¥ Import</button>
                <button class="header-btn export-btn" onclick="exportToExcel()">ðŸ“Š Export</button>
            </div>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('bookings')">ðŸ“‹ Bookings</div>
                <div class="tab" onclick="switchTab('dashboard')">ðŸ“Š Dashboard</div>
                <div class="tab" onclick="switchTab('calendar')">ðŸ“… Calendar</div>
            </div>
            <div class="content">
                <div id="bookings-content" class="tab-content">
                    <form id="bookingForm" class="booking-form"></form>
                    <div class="filter-bar"></div>
                    <div class="booking-table"></div>
                </div>
                <div id="dashboard-content" class="tab-content" style="display:none;"></div>
                <div id="calendar-content" class="tab-content" style="display:none;"></div>
            </div>
        </div>
        <div id="bookingDetailsPanel" style="display:none;"></div>
    </div>

<script>
// --- START: FIREBASE SETUP ---
if (typeof firebaseConfig !== 'undefined') {
    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();
} else {
    console.error("Firebase config object not found. Make sure `firebase-config.js` is loaded correctly.");
    document.body.innerHTML = '<h1>Firebase configuration is missing. Please set up `firebase-config.js`.</h1>';
}
// --- END: FIREBASE SETUP ---

// --- Authentication & Session Management ---
let inactivityTimer;
function handleLogin() { /* ... unchanged ... */ }
function signOut() { /* ... unchanged ... */ }
function resetInactivityTimer() { /* ... unchanged ... */ }
async function showApp() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-wrapper').style.display = 'block';
    
    await setupBookingFilters();
    await displayBookings(); 
    await calendar.renderCalendar(); 
    await updateDashboard();
    
    resetInactivityTimer();
    ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => 
        window.addEventListener(event, resetInactivityTimer)
    );
}

// --- Main Application ---
const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

function toggleRecurringOptions() { /* ... unchanged ... */ }

class FirebaseDB { /* ... unchanged ... */ }
const db = new FirebaseDB();
let monthlyRevenueChart;

async function isConflict(bookingData) { /* ... unchanged ... */ }
async function addBooking() { /* ... unchanged ... */ }

async function updateDashboard() {
    const bookings = await db.getAllBookings();
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const uniqueYears = [...new Set(bookings.map(b => new Date(b.date).getFullYear()))].sort((a, b) => b - a);
    if (uniqueYears.length === 0) { uniqueYears.push(currentYear); }

    const chartYearFilter = document.getElementById('yearFilter');
    const repeatMonthFilter = document.getElementById('repeatClientMonthFilter');
    const repeatYearFilter = document.getElementById('repeatClientYearFilter');
    const pitchMonthFilter = document.getElementById('pitchRevenueMonthFilter');
    const pitchYearFilter = document.getElementById('pitchRevenueYearFilter');

    const allFilters = [
        { el: chartYearFilter, val: 'chartYear', type: 'year' },
        { el: repeatMonthFilter, val: 'repeatMonth', type: 'month' },
        { el: repeatYearFilter, val: 'repeatYear', type: 'year' },
        { el: pitchMonthFilter, val: 'pitchMonth', type: 'month' },
        { el: pitchYearFilter, val: 'pitchYear', type: 'year' },
    ];
    
    const selectedVals = allFilters.reduce((acc, f) => ({...acc, [f.val]: f.el.value}), {});

    allFilters.forEach(filter => {
        if (filter.type === 'month' && filter.el.options.length === 0) {
            monthNames.forEach((month, index) => filter.el.innerHTML += `<option value="${index}">${month}</option>`);
        } else if (filter.type === 'year') {
            filter.el.innerHTML = '';
            uniqueYears.forEach(year => filter.el.innerHTML += `<option value="${year}">${year}</option>`);
        }
    });

    chartYearFilter.value = selectedVals.chartYear && uniqueYears.includes(parseInt(selectedVals.chartYear)) ? selectedVals.chartYear : uniqueYears[0];
    repeatMonthFilter.value = selectedVals.repeatMonth || currentMonth;
    repeatYearFilter.value = selectedVals.repeatYear && uniqueYears.includes(parseInt(selectedVals.repeatYear)) ? selectedVals.repeatYear : currentYear;
    pitchMonthFilter.value = selectedVals.pitchMonth || currentMonth;
    pitchYearFilter.value = selectedVals.pitchYear && uniqueYears.includes(parseInt(selectedVals.pitchYear)) ? selectedVals.pitchYear : currentYear;
    
    document.getElementById('totalRevenue').textContent = `AED ${bookings.reduce((s, b) => s + b.totalPayment, 0).toFixed(2)}`;
    document.getElementById('monthlyRevenue').textContent = `AED ${bookings.filter(b => { const d = new Date(b.date); return d.getFullYear() === currentYear && d.getMonth() === currentMonth; }).reduce((s, b) => s + b.totalPayment, 0).toFixed(2)}`;
    document.getElementById('yearlyRevenue').textContent = `AED ${bookings.filter(b => new Date(b.date).getFullYear() === currentYear).reduce((s, b) => s + b.totalPayment, 0).toFixed(2)}`;
    document.getElementById('totalBookingsCount').textContent = bookings.length;

    const yearForPitch = parseInt(pitchYearFilter.value);
    const monthForPitch = parseInt(pitchMonthFilter.value);
    const filteredForPitch = bookings.filter(b => { const d = new Date(b.date); return d.getFullYear() === yearForPitch && d.getMonth() === monthForPitch; });
    const pitchRevenue = filteredForPitch.reduce((acc, b) => { acc[b.pitch] = (acc[b.pitch] || 0) + b.totalPayment; return acc; }, {});
    document.getElementById('pitchRevenueBreakdown').innerHTML = Object.keys(pitchRevenue).length === 0 ? `<div class="empty-state">No revenue data for this period.</div>` : Object.entries(pitchRevenue).map(([pitch, revenue]) => `<div style="padding: 6px 0; display:flex; justify-content:space-between; border-bottom: 1px solid #eee;"><strong>${pitch}:</strong> <span>AED ${revenue.toFixed(2)}</span></div>`).join('');

    const yearForRepeat = parseInt(repeatYearFilter.value);
    const monthForRepeat = parseInt(repeatMonthFilter.value);
    const filteredForRepeat = bookings.filter(b => { const d = new Date(b.date); return d.getFullYear() === yearForRepeat && d.getMonth() === monthForRepeat; });
    const bookingsByClient = filteredForRepeat.reduce((acc, b) => { acc[b.clientName] = acc[b.clientName] || []; acc[b.clientName].push(b); return acc; }, {});
    const repeatClientRevenue = Object.entries(bookingsByClient).filter(([, b]) => b.length > 1).reduce((acc, [name, b]) => { acc[name] = b.reduce((s, i) => s + i.totalPayment, 0); return acc; }, {});
    document.getElementById('repeatClientRevenue').innerHTML = Object.keys(repeatClientRevenue).length === 0 ? `<div class="empty-state">No repeat clients for this period.</div>` : Object.entries(repeatClientRevenue).sort(([, a], [, b]) => b - a).map(([c, r]) => `<div style="padding: 6px 0; display:flex; justify-content:space-between; border-bottom: 1px solid #eee;"><strong>${c}:</strong> <span>AED ${r.toFixed(2)}</span></div>`).join('');

    const selectedYearForChart = parseInt(chartYearFilter.value);
    const monthlyData = Array(12).fill(0);
    bookings.filter(b => new Date(b.date).getFullYear() === selectedYearForChart).forEach(b => { monthlyData[new Date(b.date).getMonth()] += b.totalPayment; });
    
    if (monthlyRevenueChart) {
        monthlyRevenueChart.data.datasets[0].data = monthlyData;
        monthlyRevenueChart.update();
    } else {
        monthlyRevenueChart = new Chart(document.getElementById('monthlyRevenueChart').getContext('2d'), { type: 'bar', data: { labels: monthNames.map(m => m.slice(0,3)), datasets: [{ label: `Revenue for ${selectedYearForChart}`, data: monthlyData, backgroundColor: 'rgba(102, 126, 234, 0.6)', borderColor: 'rgba(102, 126, 234, 1)', borderWidth: 1, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: value => `AED ${value}` } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: context => ` Revenue: AED ${context.raw.toFixed(2)}` } } } } });
    }
}

async function setupBookingFilters() {
    const pitchFilter = document.getElementById('filterPitch');
    const monthFilter = document.getElementById('filterMonth');
    const yearFilter = document.getElementById('filterYear');
    const uniquePitches = ['Fifa Pitch', 'Junior Football Pitch', 'Airdome'];
    const bookings = await db.getAllBookings();
    const uniqueYears = [...new Set(bookings.map(b => new Date(b.date).getFullYear()))].sort((a, b) => b - a);

    pitchFilter.innerHTML = '<option value="">All Pitches</option>';
    uniquePitches.forEach(p => pitchFilter.innerHTML += `<option value="${p}">${p}</option>`);

    monthFilter.innerHTML = '<option value="">All Months</option>';
    monthNames.forEach((m, i) => monthFilter.innerHTML += `<option value="${i}">${m}</option>`);

    yearFilter.innerHTML = '<option value="">All Years</option>';
    uniqueYears.forEach(y => yearFilter.innerHTML += `<option value="${y}">${y}</option>`);
}

function clearBookingFilters() { /* ... unchanged ... */ }
async function displayBookings(){ /* ... unchanged ... */ }
async function deleteBooking(id){ /* ... unchanged ... */ }
function switchTab(tab){ /* ... unchanged ... */ }
async function exportToExcel() { /* ... unchanged ... */ }
async function handleFileUpload(event) { /* ... unchanged ... */ }
class CalendarController{ /* ... unchanged ... */ }
const calendar=new CalendarController();
function navigateMonth(d){calendar.navigateMonth(d);} function goToToday(){calendar.goToToday();}
function closeBookingDetails(){document.getElementById("bookingDetailsPanel").style.display="none";}
async function deleteBookingFromCalendar(id){ await deleteBooking(id); closeBookingDetails(); }

document.addEventListener("DOMContentLoaded",()=>{ 
    if (localStorage.getItem('isLoggedIn') === 'true' || sessionStorage.getItem('isLoggedIn') === 'true') {
        showApp();
    } else {
        document.getElementById('login-screen').style.display = 'flex';
    }
    document.getElementById('yearFilter').addEventListener('change', updateDashboard);
    document.getElementById('repeatClientMonthFilter').addEventListener('change', updateDashboard);
    document.getElementById('repeatClientYearFilter').addEventListener('change', updateDashboard);
    document.getElementById('pitchRevenueMonthFilter').addEventListener('change', updateDashboard);
    document.getElementById('pitchRevenueYearFilter').addEventListener('change', updateDashboard);
    document.getElementById('filterClientName').addEventListener('input', displayBookings);
    document.getElementById('filterPitch').addEventListener('change', displayBookings);
    document.getElementById('filterMonth').addEventListener('change', displayBookings);
    document.getElementById('filterYear').addEventListener('change', displayBookings);
    document.getElementById('password').addEventListener('keypress', function(e){ if (e.key === 'Enter') handleLogin(); });
});
</script>
</body>
</html>
